(function(){"use strict";if(!window.CZCR)return;const a=window.CZCR,l=(()=>{try{return new URLSearchParams(location.search).get("czcr_debug")==="1"?!0:localStorage.getItem("czcr_debug")==="1"}catch{return!1}})(),d=l?(...e)=>console.debug("[CZCR]",...e):()=>{},U=l?e=>console.group("[CZCR]",e):()=>{},Z=l?()=>console.groupEnd():()=>{};l&&(window.CZCR_DEBUG={on:!0,off(){try{localStorage.removeItem("czcr_debug")}catch{}console.info("[CZCR] debug OFF (reload)")},onNow(){try{localStorage.setItem("czcr_debug","1")}catch{}console.info("[CZCR] debug ON (reload)")}},U("BOOT"),d("version",a.version,"logged?",!!(a.user&&a.user.loggedIn)),d("postCtx",a.post||null),d("urls",a.urls),Z());const S=!!(a.user&&a.user.loggedIn),B=a.storageKey||"czcr_progress_v1",ce=typeof a.saveStep=="number"?a.saveStep:1,ie=typeof a.throttleMs=="number"?a.throttleMs:300,j=typeof a.decreaseDwellMs=="number"?a.decreaseDwellMs:1200,le=typeof a.topNoSaveRatio=="number"?a.topNoSaveRatio:.15,de=typeof a.peakGuardRatio=="number"?a.peakGuardRatio:.5,T=()=>{try{const e=localStorage.getItem(B);return e?JSON.parse(e):{}}catch{return{}}},A=e=>{try{localStorage.setItem(B,JSON.stringify(e||{}))}catch{}},ue=()=>{try{localStorage.removeItem(B)}catch{}};async function N(e,{method:t="GET",body:n}={}){const r=a.rest&&a.rest.root?a.rest.root:"",o=(r.endsWith("/")?r:r+"/")+String(e||"").replace(/^\/+/,""),c={"Content-Type":"application/json"};a.rest&&a.rest.nonce&&(c["X-WP-Nonce"]=a.rest.nonce),l&&d("API \u2192",t,o,n?{body:n}:"(no body)");const s=await fetch(o,{method:t,headers:c,credentials:"same-origin",body:n?JSON.stringify(n):void 0});let i="";try{i=await s.text()}catch{}if(l&&d("API \u2190",s.status,i),!s.ok)throw new Error(`API ${t} ${o} failed: ${s.status}`);try{return i?JSON.parse(i):{}}catch{return{}}}const E=(e,t,n)=>Math.max(t,Math.min(n,e)),ge=(e,t)=>Math.floor(e/t)*t;function fe(e,t){let n=0,r=null,o,c;const s=()=>{n=Date.now(),r=null,e.apply(c,o),o=c=null};return function(...i){const g=Date.now(),m=t-(g-n);o=i,c=this,m<=0||m>t?(r&&(clearTimeout(r),r=null),s()):r||(r=setTimeout(s,m))}}let J=-1;function L(){const e=document.documentElement,t=Math.max(e.scrollHeight,document.body.scrollHeight);return l&&t!==J&&(d("docHeights changed",{h:t,innerH:window.innerHeight,scrollY:window.scrollY}),J=t),t}if(l&&"ResizeObserver"in window){const e=new ResizeObserver(()=>L());try{e.observe(document.documentElement),e.observe(document.body)}catch{}}function pe({onResume:e,onStartOver:t}){const n=document.createElement("div");n.className="czcr-resume-modal",n.innerHTML=`
      <div class="czcr-resume-backdrop" role="presentation"></div>
      <div class="czcr-resume-dialog" role="dialog" aria-labelledby="czcr-resume-title" aria-modal="true">
        <h3 id="czcr-resume-title">${a.i18n&&a.i18n.continue_title?a.i18n.continue_title:"Continua a leggere"}</h3>
        <p>${a.i18n&&a.i18n.continue_msg?a.i18n.continue_msg:"Vuoi continuare da dove avevi interrotto?"}</p>
        <div class="czcr-resume-actions">
          <button type="button" class="czcr-btn czcr-btn-primary" data-act="resume">${a.i18n&&a.i18n.continue_yes?a.i18n.continue_yes:"Continua"}</button>
          <button type="button" class="czcr-btn" data-act="start">${a.i18n&&a.i18n.continue_no?a.i18n.continue_no:"Annulla"}</button>
        </div>
      </div>`,document.body.appendChild(n);const r=()=>n.remove();n.querySelector('[data-act="resume"]').addEventListener("click",()=>{try{e()}finally{r()}}),n.querySelector('[data-act="start"]').addEventListener("click",()=>{try{t()}finally{r()}})}function $(e){return`czcr_resume_visit_${e}`}function G(e){return`czcr_resume_asked_${e}`}function K(e,t){try{sessionStorage.setItem($(e),t?"1":"")}catch{}}function me(e){try{sessionStorage.removeItem($(e))}catch{}}function Oe(e){try{return sessionStorage.getItem($(e))==="1"}catch{return!1}}function W(e){try{sessionStorage.setItem(G(e),"1")}catch{}}function he(e){try{return sessionStorage.getItem(G(e))==="1"}catch{return!1}}function we(e){try{sessionStorage.removeItem(G(e))}catch{}}function X(e){try{const t=new URL(e,location.origin);return t.pathname=t.pathname.replace(/\/\d+\/?$/,"/"),t.origin+t.pathname}catch{return e||""}}function Q(e){const t=X(e);try{const n=document.referrer?new URL(document.referrer):null;return n?X(n.href)===t:!1}catch{return!1}}async function _e(e){if(Q(e.permalink)||he(e.id))return;let t=null;if(S)try{const w=await N("/progress");t=w&&w[e.id]}catch{}else{const w=T();t=w&&w[e.id]}if(!t)return;const n=Number(t.last_page||1),r=Number(t.total_pages||1),o=t.pages||{},c=E(Number(o[n]||0),0,100),s=E(Number(t.percent_overall||0),0,100);if(!(s>0&&s<100)||c<5)return;const i=Number(e.currentPage||1),g=n!==i,m=L(),h=window.scrollY+window.innerHeight/2,_=E(h/Math.max(1,m)*100,0,100);!g&&Math.abs(_-c)<5||(l&&d("resume: offer",{lp:n,currentPage:i,needPageJump:g,targetPct:c,currentPct:_}),pe({onResume:()=>{try{W(e.id)}catch{}if(g){const w=(e.permalink||"").replace(/\/?$/,"/"),y=n>1?w+String(n)+"/":w;window.location.href=y}else x(c)},onStartOver:()=>{try{W(e.id)}catch{}window.scrollTo({top:0,behavior:"smooth"})}}))}function x(e){const t=L(),n=E(e/100*t,0,t),r=E(n-window.innerHeight/2,0,Math.max(0,t-window.innerHeight));window.scrollTo({top:r,behavior:"instant"in window?"instant":"auto"})}function ye(){const e=document.querySelector(".czcr-toolbar");if(!e)return;const t=e.querySelector("[data-czcr-home]"),n=e.querySelector("[data-czcr-top]"),r=document.querySelector("header.site-header");if("IntersectionObserver"in window&&r)new IntersectionObserver(c=>{const s=c[0],i=!!(s&&s.isIntersecting&&s.intersectionRatio>0);e.classList.toggle("is-visible",!i),l&&d("toolbar vis",{headerVisible:i,toolbarVisible:e.classList.contains("is-visible")})},{root:null,threshold:[0,.01,1]}).observe(r);else{const o=()=>{let c=!1;if(r){const s=r.getBoundingClientRect();c=s.bottom>0&&s.top<window.innerHeight}else c=window.scrollY<=10;l&&d("toolbar vis (fallback)",{headerVisible:c,scrollY:window.scrollY}),e.classList.toggle("is-visible",!c)};window.addEventListener("scroll",o,{passive:!0}),window.addEventListener("resize",o,{passive:!0}),o()}t&&t.addEventListener("click",o=>{o.preventDefault();const c=a.urls&&a.urls.home||"/";window.location.href=c}),n&&n.addEventListener("click",o=>{o.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})})}function ee(e,t){t=Math.max(1,Number(t)||1);let n=0;for(let r=1;r<=t;r++)n+=E(e[r]||0,0,100)/100;return E(n/t*100,0,100)}function ve(e){if(l&&d("startTracking",e),!e||!e.id)return;(function(){const p=document.querySelector(a.selectors.postPagination);p&&p.querySelectorAll("a[href]").forEach(z=>{z.addEventListener("click",()=>{K(e.id,!0)},{capture:!0,passive:!0})})})();let t=!1;const n=()=>{t=!0};window.addEventListener("scroll",n,{passive:!0,once:!0}),window.addEventListener("wheel",n,{passive:!0,once:!0}),window.addEventListener("touchstart",n,{passive:!0,once:!0}),window.addEventListener("keydown",n,{once:!0});const r=0,o=120;let c=!1,s=-1,i=!1,g=0,m=null,h=null;document.addEventListener("czcr:lock",u=>{!u||!u.detail||Number(u.detail.post_id)===Number(e.id)&&(i=!!u.detail.locked)});const _=document.querySelector(a.selectors.footnotes),w=document.querySelector(a.selectors.postPagination),y=document.querySelector(a.selectors.postFooter);function O(){if(!t)return l&&d("bottom? NO (no user interaction)"),!1;const u=window.scrollY+window.innerHeight/2,p=L(),z=p<=window.innerHeight+200,k=[_,w,y].filter(Boolean);let I=1/0;if(e.totalPages===1&&(window.scrollY+window.innerHeight/2)/Math.max(1,p)<.8)return!1;if(k.length){const ae=p*.6;for(const ze of k){const F=ze.getBoundingClientRect().top+window.scrollY;F>=ae&&F<I&&(I=F)}}if(!(e.totalPages<=1||Number(e.currentPage)===Number(e.totalPages)))return l&&d("bottom? NO (not last page)"),c=!1,!1;const P=window.scrollY+window.innerHeight>=p-2,D=window.scrollY+window.innerHeight<p-40,v=I!==1/0,ne=v&&u>=I+r,re=v&&u<I-o,oe=z?!1:P,se=z?!0:D,ke=c;return c?(re||I===1/0)&&se&&(c=!1):(ne||oe)&&(c=!0),l&&ke!==c&&(U("BOTTOM LATCH CHANGE"),d("latched ->",c),d({centerY:u,docH:p,isSmallPage:z,enterByTargets:ne,exitByTargets:re,enterByViewport:oe,exitByViewport:se,triggerTop:I}),Z()),c}function R(){let p=(window.scrollY+window.innerHeight/2)/Math.max(1,L())*100;return O()&&(p=100),e.totalPages===1&&window.scrollY<10&&(p=Math.min(p,99.9)),l&&d("currentPagePercent",{percent:p,scrollY:window.scrollY,innerH:window.innerHeight}),E(p,0,100)}let f;S?f={post_id:e.id,pages:{},last_page:1,total_pages:e.totalPages,percent_overall:0,status:"reading",updated_at:new Date().toISOString()}:f=T()[e.id]||{post_id:e.id,pages:{},last_page:1,total_pages:e.totalPages,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};for(let u=1;u<=e.totalPages;u++)typeof f.pages[u]!="number"&&(f.pages[u]=0);f.total_pages=e.totalPages,g=E(f.percent_overall||0,0,100);function M(){if(!t)return;const u=Number(e.currentPage)||1,p=R(),z=Object.assign({},f.pages,{[u]:p});for(let v=1;v<u;v++)(typeof z[v]!="number"||z[v]<100)&&(z[v]=100);const k=ee(z,f.total_pages);if(e.totalPages===1&&p>=100&&window.scrollY<10)return;const te=(window.scrollY+window.innerHeight/2)/Math.max(1,L())<=le&&g>=de*100;let P=!0;if(k<f.percent_overall-.1?te?(m===null&&(m=performance.now(),h=k),P=performance.now()-m>=j):h===null||k>=h?(h=k,m=performance.now(),P=!1):(m===null&&(m=performance.now()),P=performance.now()-m>=j):(m=null,h=null),!P)return;const D=ge(k,ce);if(!(D<=s&&p<100))if(f.pages[u]=p,f.last_page=u,f.percent_overall=k,f.updated_at=new Date().toISOString(),s=D,g=Math.max(g,k),l&&d("SAVE",{page:u,inPage:p,overall:k,rounded:D,pages:f.pages}),S)N("/progress",{method:"POST",body:{post_id:e.id,pages:f.pages,last_page:f.last_page,total_pages:f.total_pages,status:"reading"}}).catch(()=>{});else{const v=T();v[e.id]=f,A(v)}}const H=fe(M,ie),C=()=>{O()?M():H()},b=()=>H();window.addEventListener("scroll",C,{passive:!0}),window.addEventListener("resize",b,{passive:!0}),window.addEventListener("beforeunload",()=>{try{M()}catch{}},{capture:!0})}function q(e){document.body.classList.toggle("czcr-readings-has",!!e),document.body.classList.toggle("czcr-readings-empty",!e),l&&d("markHasReadings",{has:!!e,section:sec})}function V(e){if((!e||!e.matches||!e.matches("[data-czcr-readings]"))&&(e=document.querySelector("[data-czcr-readings]")),!e)return;const t=e.querySelector("ul.czcr-list, [data-czcr-guest-list]"),n=t?t.children.length:0;e.hidden=n===0,q(n>0),S||(Y(n>0),t&&n===0&&(t.innerHTML="")),l&&d("updateReadingsEmptyState \u2192",{count:n,hidden:e.hidden,isLogged:S})}function be(e){document.querySelectorAll("[data-czcr-mark]").forEach(t=>{const n=t.querySelector(".czcr-mark-btn"),r=t.querySelector(".czcr-mark-label"),o=Number(t.getAttribute("data-post-id")),c=s=>{!n||!r||(n.setAttribute("aria-pressed",s?"true":"false"),r.textContent=s?a.i18n.mark_as_unread:a.i18n.mark_as_read,document.dispatchEvent(new CustomEvent("czcr:lock",{detail:{post_id:o,locked:s}})))};if(n&&n.addEventListener("click",async()=>{const s=n.getAttribute("aria-pressed")!=="true";if(S)try{await N("/mark",{method:"POST",body:{post_id:o,locked:s}})}catch{}else{const i=T(),g=i[o]||{post_id:o,pages:{},last_page:1,total_pages:e?e.total_pages:1,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};g.status=s?"locked_done":"reading",s&&(g.percent_overall=100),g.updated_at=new Date().toISOString(),i[o]=g,A(i)}c(s)}),!S){const i=T()[o];i&&i.status==="locked_done"&&c(!0)}}),document.querySelectorAll(".czcr-readings .czcr-list-mark").forEach(t=>{t.addEventListener("click",async n=>{const r=n.currentTarget.closest(".czcr-item");if(!r)return;const o=r.closest("[data-czcr-readings]"),c=Number(r.getAttribute("data-post-id"));if(S)try{await N("/mark",{method:"POST",body:{post_id:c,locked:!0}})}catch{}else{const s=T(),i=s[c]||{post_id:c,pages:{},last_page:1,total_pages:1,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};i.status="locked_done",i.percent_overall=100,i.updated_at=new Date().toISOString(),s[c]=i,A(s)}r.remove(),V(o)})})}function Se(){const e=document.querySelector("[data-czcr-readings]");if(e&&!S){const t=e.querySelector("[data-czcr-guest-list]"),n=e.querySelector("[data-czcr-guest-msg]");if(!t)return;const r=T(),o=[];for(const s of Object.keys(r||{})){const i=r[s];if(!i||i.status==="locked_done")continue;const g=Number(i.percent_overall||0);g<=0||g>=100||o.push({pid:Number(s),rec:i})}if(o.length===0){e.hidden=!0,Y(!1),q(!1),t&&(t.innerHTML=""),n&&(n.textContent=""),l&&d("guest readings empty \u2192 hide");return}const c=o.map(s=>s.pid).join(",");N(`/lookup?ids=${encodeURIComponent(c)}`,{method:"GET"}).then(s=>{const i=T(),g=[];for(const{pid:m,rec:h}of o){const _=s&&s[m];if(!_||!_.permalink)continue;const w=Number(_.total_pages||h.total_pages||1),y={};for(let b=1;b<=w;b++){const u=h.pages&&typeof h.pages[b]=="number"?h.pages[b]:0;y[b]=E(Number(u),0,100)}const O=Math.max(1,Number(h.last_page||1));for(let b=1;b<Math.min(O,w);b++)y[b]<100&&(y[b]=100);const R=ee(y,w);h.pages=y,h.total_pages=w,h.percent_overall=R,i[m]=h;const f=O,M=Math.max(0,Math.min(100,Math.round(R))),H=_.permalink.replace(/\/?$/,"/");let C=f>1?H+String(f)+"/":H;g.push(`<li class="czcr-item" data-post-id="${m}">
                 <div class="czcr-top"><a class="czcr-link" href="${C}">${_.title||"\u2014"}</a></div>
                 <div class="czcr-bottom">
                   <span class="czcr-percent">${M}%</span>
                   <button type="button" class="czcr-list-mark">Segna come letto</button>
                 </div>
               </li>`)}A(i),t.innerHTML=g.join(""),t.querySelectorAll(".czcr-list-mark").forEach(m=>{m.addEventListener("click",h=>{const _=h.currentTarget.closest(".czcr-item");if(!_)return;const w=_.closest("[data-czcr-readings]"),y=Number(_.getAttribute("data-post-id")),O=T(),R=O[y]||{post_id:y,pages:{},last_page:1,total_pages:1,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};R.status="locked_done",R.percent_overall=100,R.updated_at=new Date().toISOString(),O[y]=R,A(O),_.remove(),V(w)})}),e.hidden=t.children.length===0,Y(!e.hidden),q(!e.hidden),n&&(n.textContent=""),l&&d("guest readings render \u2192",{count:t.children.length,hidden:e.hidden})}).catch(()=>{e.hidden=!0,Y(!1),q(!1)});return}}function Re(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function Y(e){S||document.documentElement.classList.toggle("czcr-has-guest-readings",!!e)}async function Ee(){if(!S)return;const e=T(),t=Object.keys(e||{});if(t.length===0)return;let n={};try{n=await N("/progress")}catch{n={}}for(const r of t){const o=e[r];if(!o)continue;if((o.status||"reading")!=="locked_done"&&Number(o.percent_overall||0)>=100){l&&d("sync SKIP dirty 100%",{pid:r,lrec:o});continue}const c=n[r],s=Date.parse(o.updated_at||0)||0,i=Date.parse(c&&c.updated_at||0)||0;if(s>i){l&&d("sync \u2192 server",{pid:r,lrec:o});try{await N("/progress",{method:"POST",body:{post_id:Number(r),pages:o.pages||{},last_page:o.last_page||1,total_pages:o.total_pages||1,status:o.status||"reading"}})}catch(g){l&&d("sync error",g)}}else l&&d("sync SKIP (server newer/equal)",{pid:r,ltime:s,stime:i})}ue(),l&&d("sync done, LS cleared")}document.addEventListener("DOMContentLoaded",async()=>{const e=window.CZCR&&window.CZCR.post||null;if(await Ee(),e&&e.id){Q(e.permalink)||(me(e.id),we(e.id)),K(e.id,!0);const n=new URLSearchParams(location.search),r=n.has("czcr_pos")?parseFloat(n.get("czcr_pos")):null;!isNaN(r)&&r!==null?requestAnimationFrame(()=>x(E(r,0,100))):_e(e),ve(e)}be(e),Se(),document.querySelectorAll("[data-czcr-readings]").forEach(t=>V(t)),ye()})})();
//# sourceMappingURL=czcr.min.js.map
