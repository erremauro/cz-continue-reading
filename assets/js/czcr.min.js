(function(){"use strict";if(!window.CZCR)return;const r=window.CZCR,l=(()=>{try{return new URLSearchParams(location.search).get("czcr_debug")==="1"?!0:localStorage.getItem("czcr_debug")==="1"}catch{return!1}})(),d=l?(...e)=>console.debug("[CZCR]",...e):()=>{},U=l?e=>console.group("[CZCR]",e):()=>{},C=l?()=>console.groupEnd():()=>{};l&&(window.CZCR_DEBUG={on:!0,off(){try{localStorage.removeItem("czcr_debug")}catch{}console.info("[CZCR] debug OFF (reload)")},onNow(){try{localStorage.setItem("czcr_debug","1")}catch{}console.info("[CZCR] debug ON (reload)")}},U("BOOT"),d("version",r.version,"logged?",!!(r.user&&r.user.loggedIn)),d("postCtx",r.post||null),d("urls",r.urls),C());const k=!!(r.user&&r.user.loggedIn),D=r.storageKey||"czcr_progress_v1",ae=typeof r.saveStep=="number"?r.saveStep:1,ce=typeof r.throttleMs=="number"?r.throttleMs:300,F=typeof r.decreaseDwellMs=="number"?r.decreaseDwellMs:1200,ie=typeof r.topNoSaveRatio=="number"?r.topNoSaveRatio:.15,le=typeof r.peakGuardRatio=="number"?r.peakGuardRatio:.5,T=()=>{try{const e=localStorage.getItem(D);return e?JSON.parse(e):{}}catch{return{}}},P=e=>{try{localStorage.setItem(D,JSON.stringify(e||{}))}catch{}},de=()=>{try{localStorage.removeItem(D)}catch{}};async function I(e,{method:t="GET",body:n}={}){const o=r.rest&&r.rest.root?r.rest.root:"",s=(o.endsWith("/")?o:o+"/")+String(e||"").replace(/^\/+/,""),c={"Content-Type":"application/json"};r.rest&&r.rest.nonce&&(c["X-WP-Nonce"]=r.rest.nonce),l&&d("API \u2192",t,s,n?{body:n}:"(no body)");const a=await fetch(s,{method:t,headers:c,credentials:"same-origin",body:n?JSON.stringify(n):void 0});let i="";try{i=await a.text()}catch{}if(l&&d("API \u2190",a.status,i),!a.ok)throw new Error(`API ${t} ${s} failed: ${a.status}`);try{return i?JSON.parse(i):{}}catch{return{}}}const S=(e,t,n)=>Math.max(t,Math.min(n,e)),ue=(e,t)=>Math.floor(e/t)*t;function ge(e,t){let n=0,o=null,s,c;const a=()=>{n=Date.now(),o=null,e.apply(c,s),s=c=null};return function(...i){const g=Date.now(),m=t-(g-n);s=i,c=this,m<=0||m>t?(o&&(clearTimeout(o),o=null),a()):o||(o=setTimeout(a,m))}}let Z=-1;function L(){const e=document.documentElement,t=Math.max(e.scrollHeight,document.body.scrollHeight);return l&&t!==Z&&(d("docHeights changed",{h:t,innerH:window.innerHeight,scrollY:window.scrollY}),Z=t),t}if(l&&"ResizeObserver"in window){const e=new ResizeObserver(()=>L());try{e.observe(document.documentElement),e.observe(document.body)}catch{}}function fe({onResume:e,onStartOver:t}){const n=document.createElement("div");n.className="czcr-resume-modal",n.innerHTML=`
      <div class="czcr-resume-backdrop" role="presentation"></div>
      <div class="czcr-resume-dialog" role="dialog" aria-labelledby="czcr-resume-title" aria-modal="true">
        <h3 id="czcr-resume-title">${r.i18n&&r.i18n.continue_title?r.i18n.continue_title:"Continua a leggere"}</h3>
        <p>${r.i18n&&r.i18n.continue_msg?r.i18n.continue_msg:"Vuoi continuare da dove avevi interrotto?"}</p>
        <div class="czcr-resume-actions">
          <button type="button" class="czcr-btn czcr-btn-primary" data-act="resume">${r.i18n&&r.i18n.continue_yes?r.i18n.continue_yes:"Continua"}</button>
          <button type="button" class="czcr-btn" data-act="start">${r.i18n&&r.i18n.continue_no?r.i18n.continue_no:"Annulla"}</button>
        </div>
      </div>`,document.body.appendChild(n);const o=()=>n.remove();n.querySelector('[data-act="resume"]').addEventListener("click",()=>{try{e()}finally{o()}}),n.querySelector('[data-act="start"]').addEventListener("click",()=>{try{t()}finally{o()}})}function $(e){return`czcr_resume_visit_${e}`}function Y(e){return`czcr_resume_asked_${e}`}function j(e,t){try{sessionStorage.setItem($(e),t?"1":"")}catch{}}function pe(e){try{sessionStorage.removeItem($(e))}catch{}}function Oe(e){try{return sessionStorage.getItem($(e))==="1"}catch{return!1}}function J(e){try{sessionStorage.setItem(Y(e),"1")}catch{}}function me(e){try{return sessionStorage.getItem(Y(e))==="1"}catch{return!1}}function he(e){try{sessionStorage.removeItem(Y(e))}catch{}}function K(e){try{const t=new URL(e,location.origin);return t.pathname=t.pathname.replace(/\/\d+\/?$/,"/"),t.origin+t.pathname}catch{return e||""}}function W(e){const t=K(e);try{const n=document.referrer?new URL(document.referrer):null;return n?K(n.href)===t:!1}catch{return!1}}async function we(e){if(W(e.permalink)||me(e.id))return;let t=null;if(k)try{const w=await I("/progress");t=w&&w[e.id]}catch{}else{const w=T();t=w&&w[e.id]}if(!t)return;const n=Number(t.last_page||1),o=Number(t.total_pages||1),s=t.pages||{},c=S(Number(s[n]||0),0,100),a=S(Number(t.percent_overall||0),0,100);if(!(a>0&&a<100)||c<5)return;const i=Number(e.currentPage||1),g=n!==i,m=L(),h=window.scrollY+window.innerHeight/2,_=S(h/Math.max(1,m)*100,0,100);!g&&Math.abs(_-c)<5||(l&&d("resume: offer",{lp:n,currentPage:i,needPageJump:g,targetPct:c,currentPct:_}),fe({onResume:()=>{try{J(e.id)}catch{}if(g){const w=(e.permalink||"").replace(/\/?$/,"/"),y=n>1?w+String(n)+"/":w;window.location.href=y}else X(c)},onStartOver:()=>{try{J(e.id)}catch{}window.scrollTo({top:0,behavior:"smooth"})}}))}function X(e){const t=L(),n=S(e/100*t,0,t),o=S(n-window.innerHeight/2,0,Math.max(0,t-window.innerHeight));window.scrollTo({top:o,behavior:"instant"in window?"instant":"auto"})}function _e(){const e=document.querySelector(".czcr-toolbar");if(!e)return;const t=e.querySelector("[data-czcr-home]"),n=e.querySelector("[data-czcr-top]"),o=document.querySelector("header.site-header");if("IntersectionObserver"in window&&o)new IntersectionObserver(c=>{const a=c[0],i=!!(a&&a.isIntersecting&&a.intersectionRatio>0);e.classList.toggle("is-visible",!i),l&&d("toolbar vis",{headerVisible:i,toolbarVisible:e.classList.contains("is-visible")})},{root:null,threshold:[0,.01,1]}).observe(o);else{const s=()=>{let c=!1;if(o){const a=o.getBoundingClientRect();c=a.bottom>0&&a.top<window.innerHeight}else c=window.scrollY<=10;l&&d("toolbar vis (fallback)",{headerVisible:c,scrollY:window.scrollY}),e.classList.toggle("is-visible",!c)};window.addEventListener("scroll",s,{passive:!0}),window.addEventListener("resize",s,{passive:!0}),s()}t&&t.addEventListener("click",s=>{s.preventDefault();const c=r.urls&&r.urls.home||"/";window.location.href=c}),n&&n.addEventListener("click",s=>{s.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})})}function Q(e,t){t=Math.max(1,Number(t)||1);let n=0;for(let o=1;o<=t;o++)n+=S(e[o]||0,0,100)/100;return S(n/t*100,0,100)}function ye(e){if(l&&d("startTracking",e),!e||!e.id)return;(function(){const p=document.querySelector(r.selectors.postPagination);p&&p.querySelectorAll("a[href]").forEach(z=>{z.addEventListener("click",()=>{j(e.id,!0)},{capture:!0,passive:!0})})})();let t=!1;const n=()=>{t=!0};window.addEventListener("scroll",n,{passive:!0,once:!0}),window.addEventListener("wheel",n,{passive:!0,once:!0}),window.addEventListener("touchstart",n,{passive:!0,once:!0}),window.addEventListener("keydown",n,{once:!0});const o=0,s=120;let c=!1,a=-1,i=!1,g=0,m=null,h=null;document.addEventListener("czcr:lock",u=>{!u||!u.detail||Number(u.detail.post_id)===Number(e.id)&&(i=!!u.detail.locked)});const _=document.querySelector(r.selectors.footnotes),w=document.querySelector(r.selectors.postPagination),y=document.querySelector(r.selectors.postFooter);function O(){if(!t)return l&&d("bottom? NO (no user interaction)"),!1;const u=window.scrollY+window.innerHeight/2,p=L(),z=p<=window.innerHeight+200,E=[_,w,y].filter(Boolean);let N=1/0;if(e.totalPages===1&&(window.scrollY+window.innerHeight/2)/Math.max(1,p)<.8)return!1;if(E.length){const se=p*.6;for(const ze of E){const V=ze.getBoundingClientRect().top+window.scrollY;V>=se&&V<N&&(N=V)}}if(!(e.totalPages<=1||Number(e.currentPage)===Number(e.totalPages)))return l&&d("bottom? NO (not last page)"),c=!1,!1;const A=window.scrollY+window.innerHeight>=p-2,q=window.scrollY+window.innerHeight<p-40,v=N!==1/0,te=v&&u>=N+o,ne=v&&u<N-s,re=z?!1:A,oe=z?!0:q,ke=c;return c?(ne||N===1/0)&&oe&&(c=!1):(te||re)&&(c=!0),l&&ke!==c&&(U("BOTTOM LATCH CHANGE"),d("latched ->",c),d({centerY:u,docH:p,isSmallPage:z,enterByTargets:te,exitByTargets:ne,enterByViewport:re,exitByViewport:oe,triggerTop:N}),C()),c}function R(){let p=(window.scrollY+window.innerHeight/2)/Math.max(1,L())*100;return O()&&(p=100),e.totalPages===1&&window.scrollY<10&&(p=Math.min(p,99.9)),l&&d("currentPagePercent",{percent:p,scrollY:window.scrollY,innerH:window.innerHeight}),S(p,0,100)}let f;k?f={post_id:e.id,pages:{},last_page:1,total_pages:e.totalPages,percent_overall:0,status:"reading",updated_at:new Date().toISOString()}:f=T()[e.id]||{post_id:e.id,pages:{},last_page:1,total_pages:e.totalPages,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};for(let u=1;u<=e.totalPages;u++)typeof f.pages[u]!="number"&&(f.pages[u]=0);f.total_pages=e.totalPages,g=S(f.percent_overall||0,0,100);function M(){if(!t)return;const u=Number(e.currentPage)||1,p=R(),z=Object.assign({},f.pages,{[u]:p});for(let v=1;v<u;v++)(typeof z[v]!="number"||z[v]<100)&&(z[v]=100);const E=Q(z,f.total_pages);if(e.totalPages===1&&p>=100&&window.scrollY<10)return;const ee=(window.scrollY+window.innerHeight/2)/Math.max(1,L())<=ie&&g>=le*100;let A=!0;if(E<f.percent_overall-.1?ee?(m===null&&(m=performance.now(),h=E),A=performance.now()-m>=F):h===null||E>=h?(h=E,m=performance.now(),A=!1):(m===null&&(m=performance.now()),A=performance.now()-m>=F):(m=null,h=null),!A)return;const q=ue(E,ae);if(!(q<=a&&p<100))if(f.pages[u]=p,f.last_page=u,f.percent_overall=E,f.updated_at=new Date().toISOString(),a=q,g=Math.max(g,E),l&&d("SAVE",{page:u,inPage:p,overall:E,rounded:q,pages:f.pages}),k)I("/progress",{method:"POST",body:{post_id:e.id,pages:f.pages,last_page:f.last_page,total_pages:f.total_pages,status:"reading"}}).catch(()=>{});else{const v=T();v[e.id]=f,P(v)}}const H=ge(M,ce),G=()=>{O()?M():H()},b=()=>H();window.addEventListener("scroll",G,{passive:!0}),window.addEventListener("resize",b,{passive:!0}),window.addEventListener("beforeunload",()=>{try{M()}catch{}},{capture:!0})}function x(e){if((!e||!e.matches||!e.matches("[data-czcr-readings]"))&&(e=document.querySelector("[data-czcr-readings]")),!!e)if(k){const t=e.querySelector("ul.czcr-list"),n=!t||t.children.length===0;l&&d("updateReadingsEmptyState (logged)",{isEmpty:n}),n&&(t&&t.remove(),e.querySelector(".czcr-empty")||e.insertAdjacentHTML("beforeend",`<p class="czcr-empty">${r.i18n.no_items}</p>`))}else{const t=e.querySelector("[data-czcr-guest-list]"),n=!t||t.children.length===0;if(l&&d("updateReadingsEmptyState (guest)",{isEmpty:n}),n){B(!1),t&&(t.innerHTML="");let o=e.querySelector("[data-czcr-guest-msg]");if(!o){const s=r.urls&&r.urls.login||"#",c=r.urls&&r.urls.register||"#";o=document.createElement("p"),o.className="czcr-guest-msg",o.setAttribute("data-czcr-guest-msg",""),o.innerHTML=`${r.i18n.login_to_keep_history.replace("Accedi",`<a href="${s}">Accedi</a>`).replace("registrati",`<a href="${c}">registrati</a>`)}`,e.appendChild(o)}}}}function ve(e){document.querySelectorAll("[data-czcr-mark]").forEach(t=>{const n=t.querySelector(".czcr-mark-btn"),o=t.querySelector(".czcr-mark-label"),s=Number(t.getAttribute("data-post-id")),c=a=>{!n||!o||(n.setAttribute("aria-pressed",a?"true":"false"),o.textContent=a?r.i18n.mark_as_unread:r.i18n.mark_as_read,document.dispatchEvent(new CustomEvent("czcr:lock",{detail:{post_id:s,locked:a}})))};if(n&&n.addEventListener("click",async()=>{const a=n.getAttribute("aria-pressed")!=="true";if(k)try{await I("/mark",{method:"POST",body:{post_id:s,locked:a}})}catch{}else{const i=T(),g=i[s]||{post_id:s,pages:{},last_page:1,total_pages:e?e.total_pages:1,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};g.status=a?"locked_done":"reading",a&&(g.percent_overall=100),g.updated_at=new Date().toISOString(),i[s]=g,P(i)}c(a)}),!k){const i=T()[s];i&&i.status==="locked_done"&&c(!0)}}),document.querySelectorAll(".czcr-readings .czcr-list-mark").forEach(t=>{t.addEventListener("click",async n=>{const o=n.currentTarget.closest(".czcr-item");if(!o)return;const s=o.closest("[data-czcr-readings]"),c=Number(o.getAttribute("data-post-id"));if(k)try{await I("/mark",{method:"POST",body:{post_id:c,locked:!0}})}catch{}else{const a=T(),i=a[c]||{post_id:c,pages:{},last_page:1,total_pages:1,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};i.status="locked_done",i.percent_overall=100,i.updated_at=new Date().toISOString(),a[c]=i,P(a)}o.remove(),x(s)})})}function be(){const e=document.querySelector("[data-czcr-readings]");if(e&&!k){const t=e.querySelector("[data-czcr-guest-list]"),n=e.querySelector("[data-czcr-guest-msg]");if(!t)return;const o=T(),s=[];for(const a of Object.keys(o||{})){const i=o[a];if(!i||i.status==="locked_done")continue;const g=Number(i.percent_overall||0);g<=0||g>=100||s.push({pid:Number(a),rec:i})}if(s.length===0){t.innerHTML="",n&&(n.textContent=r.i18n.no_items),B(!1),l&&d("guest readings body class",{has:!1,entries:s.length});return}const c=s.map(a=>a.pid).join(",");if(I(`/lookup?ids=${encodeURIComponent(c)}`,{method:"GET"}).then(a=>{const i=T(),g=[];for(const{pid:m,rec:h}of s){const _=a&&a[m];if(!_||!_.permalink)continue;const w=Number(_.total_pages||h.total_pages||1),y={};for(let b=1;b<=w;b++){const u=h.pages&&typeof h.pages[b]=="number"?h.pages[b]:0;y[b]=S(Number(u),0,100)}const O=Math.max(1,Number(h.last_page||1));for(let b=1;b<Math.min(O,w);b++)y[b]<100&&(y[b]=100);const R=Q(y,w);h.pages=y,h.total_pages=w,h.percent_overall=R,i[m]=h;const f=O,M=Math.max(0,Math.min(100,Math.round(R))),H=_.permalink.replace(/\/?$/,"/");let G=f>1?H+String(f)+"/":H;g.push(`<li class="czcr-item" data-post-id="${m}">
                 <div class="czcr-top"><a class="czcr-link" href="${G}">${Se(_.title||"\u2014")}</a></div>
                 <div class="czcr-bottom">
                   <span class="czcr-percent">${M}%</span>
                   <button type="button" class="czcr-list-mark">Segna come letto</button>
                 </div>
               </li>`)}P(i),t.innerHTML=g.join(""),t.querySelectorAll(".czcr-list-mark").forEach(m=>{m.addEventListener("click",h=>{const _=h.currentTarget.closest(".czcr-item");if(!_)return;const w=_.closest("[data-czcr-readings]"),y=Number(_.getAttribute("data-post-id")),O=T(),R=O[y]||{post_id:y,pages:{},last_page:1,total_pages:1,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};R.status="locked_done",R.percent_overall=100,R.updated_at=new Date().toISOString(),O[y]=R,P(O),_.remove(),x(w)})}),B(!0),l&&d("guest readings body class",{has:!0,entries:s.length})}).catch(()=>{}),n){const a=r.urls&&r.urls.login?r.urls.login:null,i=r.urls&&r.urls.register?r.urls.register:null;a&&i&&(n.innerHTML=`${r.i18n.login_to_keep_history.replace("Accedi",`<a href="${a}">Accedi</a>`).replace("registrati",`<a href="${i}">registrati</a>`)}`)}return}}function Se(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function B(e){k||document.documentElement.classList.toggle("czcr-has-guest-readings",!!e)}async function Ee(){if(!k)return;const e=T(),t=Object.keys(e||{});if(t.length===0)return;let n={};try{n=await I("/progress")}catch{n={}}for(const o of t){const s=e[o];if(!s)continue;if((s.status||"reading")!=="locked_done"&&Number(s.percent_overall||0)>=100){l&&d("sync SKIP dirty 100%",{pid:o,lrec:s});continue}const c=n[o],a=Date.parse(s.updated_at||0)||0,i=Date.parse(c&&c.updated_at||0)||0;if(a>i){l&&d("sync \u2192 server",{pid:o,lrec:s});try{await I("/progress",{method:"POST",body:{post_id:Number(o),pages:s.pages||{},last_page:s.last_page||1,total_pages:s.total_pages||1,status:s.status||"reading"}})}catch(g){l&&d("sync error",g)}}else l&&d("sync SKIP (server newer/equal)",{pid:o,ltime:a,stime:i})}de(),l&&d("sync done, LS cleared")}document.addEventListener("DOMContentLoaded",async()=>{const e=window.CZCR&&window.CZCR.post||null;if(await Ee(),e&&e.id){W(e.permalink)||(pe(e.id),he(e.id)),j(e.id,!0);const n=new URLSearchParams(location.search),o=n.has("czcr_pos")?parseFloat(n.get("czcr_pos")):null;!isNaN(o)&&o!==null?requestAnimationFrame(()=>X(S(o,0,100))):we(e),ye(e)}ve(e),be(),_e()})})();
//# sourceMappingURL=czcr.min.js.map
