(function(){"use strict";if(!window.CZCR)return;const a=window.CZCR,d=(()=>{try{return new URLSearchParams(location.search).get("czcr_debug")==="1"?!0:localStorage.getItem("czcr_debug")==="1"}catch{return!1}})(),u=d?(...e)=>console.debug("[CZCR]",...e):()=>{},$=d?e=>console.group("[CZCR]",e):()=>{},G=d?()=>console.groupEnd():()=>{};d&&(window.CZCR_DEBUG={on:!0,off(){try{localStorage.removeItem("czcr_debug")}catch{}console.info("[CZCR] debug OFF (reload)")},onNow(){try{localStorage.setItem("czcr_debug","1")}catch{}console.info("[CZCR] debug ON (reload)")}},$("BOOT"),u("version",a.version,"logged?",!!(a.user&&a.user.loggedIn)),u("postCtx",a.post||null),u("urls",a.urls),G());const E=!!(a.user&&a.user.loggedIn),D=a.storageKey||"czcr_progress_v1",ee=typeof a.saveStep=="number"?a.saveStep:1,te=typeof a.throttleMs=="number"?a.throttleMs:300,U=typeof a.decreaseDwellMs=="number"?a.decreaseDwellMs:1200,re=typeof a.topNoSaveRatio=="number"?a.topNoSaveRatio:.15,ne=typeof a.peakGuardRatio=="number"?a.peakGuardRatio:.5,T=()=>{try{const e=localStorage.getItem(D);return e?JSON.parse(e):{}}catch{return{}}},A=e=>{try{localStorage.setItem(D,JSON.stringify(e||{}))}catch{}},oe=()=>{try{localStorage.removeItem(D)}catch{}};async function R(e,{method:t="GET",body:r}={}){const n=a.rest&&a.rest.root?a.rest.root:"",o=(n.endsWith("/")?n:n+"/")+String(e||"").replace(/^\/+/,""),c={"Content-Type":"application/json"};a.rest&&a.rest.nonce&&(c["X-WP-Nonce"]=a.rest.nonce),d&&u("API \u2192",t,o,r?{body:r}:"(no body)");const s=await fetch(o,{method:t,headers:c,credentials:"same-origin",body:r?JSON.stringify(r):void 0});let i="";try{i=await s.text()}catch{}if(d&&u("API \u2190",s.status,i),!s.ok)throw new Error(`API ${t} ${o} failed: ${s.status}`);try{return i?JSON.parse(i):{}}catch{return{}}}const b=(e,t,r)=>Math.max(t,Math.min(r,e)),se=(e,t)=>Math.floor(e/t)*t;function ae(e,t){let r=0,n=null,o,c;const s=()=>{r=Date.now(),n=null,e.apply(c,o),o=c=null};return function(...i){const g=Date.now(),f=t-(g-r);o=i,c=this,f<=0||f>t?(n&&(clearTimeout(n),n=null),s()):n||(n=setTimeout(s,f))}}let F=-1;function I(){const e=document.documentElement,t=Math.max(e.scrollHeight,document.body.scrollHeight);return d&&t!==F&&(u("docHeights changed",{h:t,innerH:window.innerHeight,scrollY:window.scrollY}),F=t),t}if(d&&"ResizeObserver"in window){const e=new ResizeObserver(()=>I());try{e.observe(document.documentElement),e.observe(document.body)}catch{}}function ce({onResume:e,onStartOver:t}){const r=document.createElement("div");r.className="czcr-resume-modal",r.innerHTML=`
      <div class="czcr-resume-backdrop" role="presentation"></div>
      <div class="czcr-resume-dialog" role="dialog" aria-labelledby="czcr-resume-title" aria-modal="true">
        <h3 id="czcr-resume-title">Continua a leggere</h3>
        <p>Vuoi continuare da dove avevi interrotto?</p>
        <div class="czcr-resume-actions">
          <button type="button" class="czcr-btn czcr-btn-primary" data-act="resume">Continua</button>
          <button type="button" class="czcr-btn" data-act="start">Annulla</button>
        </div>
      </div>`,document.body.appendChild(r);const n=()=>r.remove();r.querySelector('[data-act="resume"]').addEventListener("click",()=>{try{e()}finally{n()}}),r.querySelector('[data-act="start"]').addEventListener("click",()=>{try{t()}finally{n()}})}async function ie(e){let t=null;if(E)try{const h=await R("/progress");t=h&&h[e.id]}catch{}else{const h=T();t=h&&h[e.id]}if(!t)return;const r=Number(t.last_page||1),n=Number(t.total_pages||1),o=t.pages||{},c=b(Number(o[r]||0),0,100),s=b(Number(t.percent_overall||0),0,100);if(!(s>0&&s<100)||c<5)return;const i=Number(e.currentPage||1),g=r!==i,f=I(),w=window.scrollY+window.innerHeight/2,_=b(w/Math.max(1,f)*100,0,100);!g&&Math.abs(_-c)<5||ce({onResume:()=>{try{sessionStorage.setItem(seenKey,"1")}catch{}if(g){const h=(e.permalink||"").replace(/\/?$/,"/"),y=r>1?h+String(r)+"/":h;window.location.href=y}else V(c)},onStartOver:()=>{try{sessionStorage.setItem(seenKey,"1")}catch{}window.scrollTo({top:0,behavior:"smooth"})}})}function V(e){const t=I(),r=b(e/100*t,0,t),n=b(r-window.innerHeight/2,0,Math.max(0,t-window.innerHeight));window.scrollTo({top:n,behavior:"instant"in window?"instant":"auto"})}function le(){const e=document.querySelector(".czcr-toolbar");if(!e)return;const t=e.querySelector("[data-czcr-home]"),r=e.querySelector("[data-czcr-top]"),n=document.querySelector("header.site-header");if("IntersectionObserver"in window&&n)new IntersectionObserver(c=>{const s=c[0],i=!!(s&&s.isIntersecting&&s.intersectionRatio>0);e.classList.toggle("is-visible",!i),d&&u("toolbar vis",{headerVisible:i,toolbarVisible:e.classList.contains("is-visible")})},{root:null,threshold:[0,.01,1]}).observe(n);else{const o=()=>{let c=!1;if(n){const s=n.getBoundingClientRect();c=s.bottom>0&&s.top<window.innerHeight}else c=window.scrollY<=10;d&&u("toolbar vis (fallback)",{headerVisible:c,scrollY:window.scrollY}),e.classList.toggle("is-visible",!c)};window.addEventListener("scroll",o,{passive:!0}),window.addEventListener("resize",o,{passive:!0}),o()}t&&t.addEventListener("click",o=>{o.preventDefault();const c=a.urls&&a.urls.home||"/";window.location.href=c}),r&&r.addEventListener("click",o=>{o.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})})}function Z(e,t){t=Math.max(1,Number(t)||1);let r=0;for(let n=1;n<=t;n++)r+=b(e[n]||0,0,100)/100;return b(r/t*100,0,100)}function de(e){if(d&&u("startTracking",e),!e||!e.id)return;let t=!1;const r=()=>{t=!0};window.addEventListener("scroll",r,{passive:!0,once:!0}),window.addEventListener("wheel",r,{passive:!0,once:!0}),window.addEventListener("touchstart",r,{passive:!0,once:!0}),window.addEventListener("keydown",r,{once:!0});const n=0,o=120;let c=!1,s=-1,i=!1,g=0,f=null,w=null;document.addEventListener("czcr:lock",l=>{!l||!l.detail||Number(l.detail.post_id)===Number(e.id)&&(i=!!l.detail.locked)});const _=document.querySelector(a.selectors.footnotes),h=document.querySelector(a.selectors.postPagination),y=document.querySelector(a.selectors.postFooter);function z(){if(!t)return d&&u("bottom? NO (no user interaction)"),!1;const l=window.scrollY+window.innerHeight/2,m=I(),k=m<=window.innerHeight+200,S=[_,h,y].filter(Boolean);let N=1/0;if(e.totalPages===1&&(window.scrollY+window.innerHeight/2)/Math.max(1,m)<.8)return!1;if(S.length){const x=m*.6;for(const he of S){const C=he.getBoundingClientRect().top+window.scrollY;C>=x&&C<N&&(N=C)}}if(!(e.totalPages<=1||Number(e.currentPage)===Number(e.totalPages)))return d&&u("bottom? NO (not last page)"),c=!1,!1;const L=window.scrollY+window.innerHeight>=m-2,P=window.scrollY+window.innerHeight<m-40,v=N!==1/0,J=v&&l>=N+n,W=v&&l<N-o,X=k?!1:L,Q=k?!0:P,me=c;return c?(W||N===1/0)&&Q&&(c=!1):(J||X)&&(c=!0),d&&me!==c&&($("BOTTOM LATCH CHANGE"),u("latched ->",c),u({centerY:l,docH:m,isSmallPage:k,enterByTargets:J,exitByTargets:W,enterByViewport:X,exitByViewport:Q,triggerTop:N}),G()),c}function O(){let m=(window.scrollY+window.innerHeight/2)/Math.max(1,I())*100;return z()&&(m=100),e.totalPages===1&&window.scrollY<10&&(m=Math.min(m,99.9)),d&&u("currentPagePercent",{percent:m,scrollY:window.scrollY,innerH:window.innerHeight}),b(m,0,100)}let p;E?p={post_id:e.id,pages:{},last_page:1,total_pages:e.totalPages,percent_overall:0,status:"reading",updated_at:new Date().toISOString()}:p=T()[e.id]||{post_id:e.id,pages:{},last_page:1,total_pages:e.totalPages,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};for(let l=1;l<=e.totalPages;l++)typeof p.pages[l]!="number"&&(p.pages[l]=0);p.total_pages=e.totalPages,g=b(p.percent_overall||0,0,100);function H(){if(!t)return;const l=Number(e.currentPage)||1,m=O(),k=Object.assign({},p.pages,{[l]:m});for(let v=1;v<l;v++)(typeof k[v]!="number"||k[v]<100)&&(k[v]=100);const S=Z(k,p.total_pages);if(e.totalPages===1&&m>=100&&window.scrollY<10)return;const K=(window.scrollY+window.innerHeight/2)/Math.max(1,I())<=re&&g>=ne*100;let L=!0;if(S<p.percent_overall-.1?K?(f===null&&(f=performance.now(),w=S),L=performance.now()-f>=U):w===null||S>=w?(w=S,f=performance.now(),L=!1):(f===null&&(f=performance.now()),L=performance.now()-f>=U):(f=null,w=null),!L)return;const P=se(S,ee);if(!(P<=s&&m<100))if(p.pages[l]=m,p.last_page=l,p.percent_overall=S,p.updated_at=new Date().toISOString(),s=P,g=Math.max(g,S),d&&u("SAVE",{page:l,inPage:m,overall:S,rounded:P,pages:p.pages}),E)R("/progress",{method:"POST",body:{post_id:e.id,pages:p.pages,last_page:p.last_page,total_pages:p.total_pages,status:"reading"}}).catch(()=>{});else{const v=T();v[e.id]=p,A(v)}}const M=ae(H,te),Y=()=>{z()?H():M()},B=()=>M();window.addEventListener("scroll",Y,{passive:!0}),window.addEventListener("resize",B,{passive:!0}),window.addEventListener("beforeunload",()=>{try{H()}catch{}},{capture:!0})}function j(e){if((!e||!e.matches||!e.matches("[data-czcr-readings]"))&&(e=document.querySelector("[data-czcr-readings]")),!!e)if(E){const t=e.querySelector("ul.czcr-list"),r=!t||t.children.length===0;d&&u("updateReadingsEmptyState (logged)",{isEmpty:r}),r&&(t&&t.remove(),e.querySelector(".czcr-empty")||e.insertAdjacentHTML("beforeend",`<p class="czcr-empty">${a.i18n.no_items}</p>`))}else{const t=e.querySelector("[data-czcr-guest-list]"),r=!t||t.children.length===0;if(d&&u("updateReadingsEmptyState (guest)",{isEmpty:r}),r){q(!1),t&&(t.innerHTML="");let n=e.querySelector("[data-czcr-guest-msg]");if(!n){const o=a.urls&&a.urls.login||"#",c=a.urls&&a.urls.register||"#";n=document.createElement("p"),n.className="czcr-guest-msg",n.setAttribute("data-czcr-guest-msg",""),n.innerHTML=`${a.i18n.login_to_keep_history.replace("Accedi",`<a href="${o}">Accedi</a>`).replace("registrati",`<a href="${c}">registrati</a>`)}`,e.appendChild(n)}}}}function ue(e){document.querySelectorAll("[data-czcr-mark]").forEach(t=>{const r=t.querySelector(".czcr-mark-btn"),n=t.querySelector(".czcr-mark-label"),o=Number(t.getAttribute("data-post-id")),c=s=>{!r||!n||(r.setAttribute("aria-pressed",s?"true":"false"),n.textContent=s?a.i18n.mark_as_unread:a.i18n.mark_as_read,document.dispatchEvent(new CustomEvent("czcr:lock",{detail:{post_id:o,locked:s}})))};if(r&&r.addEventListener("click",async()=>{const s=r.getAttribute("aria-pressed")!=="true";if(E)try{await R("/mark",{method:"POST",body:{post_id:o,locked:s}})}catch{}else{const i=T(),g=i[o]||{post_id:o,pages:{},last_page:1,total_pages:e?e.total_pages:1,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};g.status=s?"locked_done":"reading",s&&(g.percent_overall=100),g.updated_at=new Date().toISOString(),i[o]=g,A(i)}c(s)}),!E){const i=T()[o];i&&i.status==="locked_done"&&c(!0)}}),document.querySelectorAll(".czcr-readings .czcr-list-mark").forEach(t=>{t.addEventListener("click",async r=>{const n=r.currentTarget.closest(".czcr-item");if(!n)return;const o=n.closest("[data-czcr-readings]"),c=Number(n.getAttribute("data-post-id"));if(E)try{await R("/mark",{method:"POST",body:{post_id:c,locked:!0}})}catch{}else{const s=T(),i=s[c]||{post_id:c,pages:{},last_page:1,total_pages:1,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};i.status="locked_done",i.percent_overall=100,i.updated_at=new Date().toISOString(),s[c]=i,A(s)}n.remove(),j(o)})})}function ge(){const e=document.querySelector("[data-czcr-readings]");if(e&&!E){const t=e.querySelector("[data-czcr-guest-list]"),r=e.querySelector("[data-czcr-guest-msg]");if(!t)return;const n=T(),o=[];for(const s of Object.keys(n||{})){const i=n[s];if(!i||i.status==="locked_done")continue;const g=Number(i.percent_overall||0);g<=0||g>=100||o.push({pid:Number(s),rec:i})}if(o.length===0){t.innerHTML="",r&&(r.textContent=a.i18n.no_items),q(!1),d&&u("guest readings body class",{has:!1,entries:o.length});return}const c=o.map(s=>s.pid).join(",");if(R(`/lookup?ids=${encodeURIComponent(c)}`,{method:"GET"}).then(s=>{const i=T(),g=[];for(const{pid:f,rec:w}of o){const _=s&&s[f];if(!_||!_.permalink)continue;const h=Number(_.total_pages||w.total_pages||1),y={};for(let l=1;l<=h;l++){const m=w.pages&&typeof w.pages[l]=="number"?w.pages[l]:0;y[l]=b(Number(m),0,100)}const z=Math.max(1,Number(w.last_page||1));for(let l=1;l<Math.min(z,h);l++)y[l]<100&&(y[l]=100);const O=Z(y,h);w.pages=y,w.total_pages=h,w.percent_overall=O,i[f]=w;const p=z,H=y[p]||0,M=_.permalink.replace(/\/?$/,"/");let Y=p>1?M+String(p)+"/":M;const B=Math.max(0,Math.min(100,Math.round(O)));g.push(`<li class="czcr-item" data-post-id="${f}">
                 <div class="czcr-top"><a class="czcr-link" href="${Y}">${pe(_.title||"\u2014")}</a></div>
                 <div class="czcr-bottom">
                   <span class="czcr-percent">${B}%</span>
                   <button type="button" class="czcr-list-mark">Segna come letto</button>
                 </div>
               </li>`)}A(i),t.innerHTML=g.join(""),t.querySelectorAll(".czcr-list-mark").forEach(f=>{f.addEventListener("click",w=>{const _=w.currentTarget.closest(".czcr-item");if(!_)return;const h=_.closest("[data-czcr-readings]"),y=Number(_.getAttribute("data-post-id")),z=T(),O=z[y]||{post_id:y,pages:{},last_page:1,total_pages:1,percent_overall:0,status:"reading",updated_at:new Date().toISOString()};O.status="locked_done",O.percent_overall=100,O.updated_at=new Date().toISOString(),z[y]=O,A(z),_.remove(),j(h)})}),q(!0),d&&u("guest readings body class",{has:!0,entries:o.length})}).catch(()=>{}),r){const s=a.urls&&a.urls.login?a.urls.login:null,i=a.urls&&a.urls.register?a.urls.register:null;s&&i&&(r.innerHTML=`${a.i18n.login_to_keep_history.replace("Accedi",`<a href="${s}">Accedi</a>`).replace("registrati",`<a href="${i}">registrati</a>`)}`)}return}}function pe(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function q(e){E||document.documentElement.classList.toggle("czcr-has-guest-readings",!!e)}async function fe(){if(!E)return;const e=T(),t=Object.keys(e||{});if(t.length===0)return;let r={};try{r=await R("/progress")}catch{r={}}for(const n of t){const o=e[n];if(!o)continue;if((o.status||"reading")!=="locked_done"&&Number(o.percent_overall||0)>=100){d&&u("sync SKIP dirty 100%",{pid:n,lrec:o});continue}const c=r[n],s=Date.parse(o.updated_at||0)||0,i=Date.parse(c&&c.updated_at||0)||0;if(s>i){d&&u("sync \u2192 server",{pid:n,lrec:o});try{await R("/progress",{method:"POST",body:{post_id:Number(n),pages:o.pages||{},last_page:o.last_page||1,total_pages:o.total_pages||1,status:o.status||"reading"}})}catch(g){d&&u("sync error",g)}}else d&&u("sync SKIP (server newer/equal)",{pid:n,ltime:s,stime:i})}oe(),d&&u("sync done, LS cleared")}document.addEventListener("DOMContentLoaded",async()=>{const e=window.CZCR&&window.CZCR.post||null;if(await fe(),e&&e.id){const t=new URLSearchParams(location.search),r=t.has("czcr_pos")?parseFloat(t.get("czcr_pos")):null;!isNaN(r)&&r!==null?requestAnimationFrame(()=>V(b(r,0,100))):ie(e),de(e)}ue(e),ge(),le()})})();
//# sourceMappingURL=czcr.min.js.map
